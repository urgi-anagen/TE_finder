#distribution based on: debian 9.5
Bootstrap:docker
From:debian:9.5-slim

# container for TE_finder 2.30
# Build:
# singularity build --remote TEfinder2.30.1.sif TEfinder2.30.1_recipes.def

%environment
export LC_ALL=C
export LC_NUMERIC=en_GB.UTF-8
export PATH="/opt/miniconda/bin:$PATH"
export PATH="/opt/TE_finder/bin:$PATH"

%labels
AUTHOR Hadi Quesneville
VERSION 2.0
LICENSE GNU
DATE_MODIF 03/05/2021
PACKAGE TE_finder (v2.30)

%help
Container for TE_finder 2.30
Install packages using Miniconda3 V4.7.10
All packages are in /opt/miniconda/bin & are in PATH
Default runscript: no

Usage:
    ./TE_finder.sif  <TE_finder software> -h
    or:
    singularity exec TE_finder.sif <TE_finder software> -h


%runscript
    #passing all arguments from cli: $@
    #!/bin/bash
        if [ $# -eq 0 ]; then
            echo "Usage:"
            echo "  TE_finder.sif  <TE_finder software> -h"
            echo "  or:"
            echo "  singularity exec TE_finder.sif <TE_finder software> -h"
            exit 1
        fi
    exec "$@"

%post

    #essential stuff but minimal
    apt update
    #for security fixe:
    #apt upgrade -y
    apt install -y wget bzip2

    #install conda
    cd /opt
    rm -fr miniconda

    #miniconda3: get miniconda3 version 4.7.10
    wget https://repo.continuum.io/miniconda/Miniconda3-4.7.10-Linux-x86_64.sh -O miniconda.sh

    #install conda
    bash miniconda.sh -b -p /opt/miniconda
    export PATH="/opt/miniconda/bin:$PATH"
    #add channels
    conda config --add channels defaults
    conda config --add channels bioconda
    conda config --add channels conda-forge

    #install blast version 2.9.0
    conda install -c bioconda blast=2.9.0

    #install TE_finder version 2.30
    apt -y install cmake
    apt -y install g++
    apt -y install libcppunit-dev
    apt -y install git
    cd /opt
    mkdir TE_finder
    cd TE_finder
    git clone https://github.com/urgi-anagen/TE_finder.git
    cd TE_finder
    cmake .
    make install
    cd ..
    mkdir bin
    cp TE_finder/bin/* bin
    cp TE_finder/src/tools/cutterDB bin
    cp TE_finder/src/tools/NWalign bin
    cp TE_finder/src/tools/SWalign bin
    cp TE_finder/src/tools/TRsearch bin
    cp TE_finder/src/tools/TSDsearch bin
    cp TE_finder/src/tools/align2piler bin
    cp TE_finder/src/tools/align2recon bin
    cp TE_finder/src/tools/fastlalign bin
    cp TE_finder/src/tools/filterAlign bin
    cp TE_finder/src/tools/halign bin
    cp TE_finder/src/tools/hrepeat bin
    cp TE_finder/src/tools/hsearch bin
    cp TE_finder/src/tools/itrsearch bin
    cp TE_finder/src/tools/ltrsearch bin
    cp TE_finder/src/tools/map2db bin
    cp TE_finder/src/tools/map2flank3 bin
    cp TE_finder/src/tools/map2flank5 bin
    cp TE_finder/src/tools/map2flank53 bin
    cp TE_finder/src/tools/mapOp bin
    cp TE_finder/src/tools/mapdist bin
    cp TE_finder/src/tools/mapsize bin
    cp TE_finder/src/tools/mapview bin
    cp TE_finder/src/tools/orienter bin
    cp TE_finder/src/tools/mapOp bin
    cp TE_finder/src/tools/pathnum2id bin
    cp TE_finder/src/tools/polyAtail bin
    cp TE_finder/src/tools/refalign bin
    cp TE_finder/src/tools/rpt_map bin
    cp TE_finder/src/tools/setnum2id bin
    cp TE_finder/src/tools/statalign bin
    cp TE_finder/src/tools/tabnum2id bin
    rm -rf TE_finder

    #cleanup
    conda clean -y --all
    rm -f /opt/miniconda.sh
    apt autoremove --purge
    apt clean
